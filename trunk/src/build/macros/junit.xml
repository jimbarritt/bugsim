<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="compile">

    <macrodef name="run-junit">
        <attribute name="configuration"/>
        <attribute name="classpath.refid"/>
        <attribute name="report.dir"/>
        <attribute name="src.test.dir"/>
        <attribute name="printsummary" default="off" /> <!-- can also be "on" which prints stats, "withOutAndErr" which sends everything to the stdout and stderr-->

        <sequential>
            <property name="junit.report.xml.dir" value="@{report.dir}/xml"/>
            <property name="junit.report.html.dir" value="@{report.dir}/html"/>
            <delete dir="@{report.dir}" />
            <mkdir dir="${junit.report.xml.dir}"/>
            <mkdir dir="${junit.report.html.dir}"/>

            <junit printsummary="@{printsummary}">
                <classpath refid="@{classpath.refid}"/>

                <formatter type="xml"/>

                <batchtest fork="yes"
                           todir="${junit.report.xml.dir}"
                           failureproperty="junit.failed"
                           haltonfailure="no"
                           haltonerror="no">

                    <fileset dir="@{src.test.dir}">
                        <include name="**/*.java"/>
                    </fileset>
                </batchtest>
            </junit>

            <junitreport todir="${junit.report.html.dir}">
                <fileset dir="${junit.report.xml.dir}">
                    <include name="*.xml"/>
                </fileset>
                <report format="frames" todir="${junit.report.html.dir}"/>
            </junitreport>

            <antcall target="fail.build.if.tests.fail" />
        </sequential>
    </macrodef>

    <target name="fail.build.if.tests.fail" if="junit.failed">
        <echo message="!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!" />
        <echo message="" />
        <echo message="   ATTENTION!! Tests are failing or have errors!" />
        <echo message="   Reports in html can be found by going to ${junit.report.html.dir}/index.html" />
        <echo message="" />
        <echo message="!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!" />

        <exec command="open ${junit.report.html.dir}/index.html" failonerror="no" spawn="yes"/>

        <fail taskname="run.junit.@{configuration}"
                  message="One or more tests failed or produced errors (LOOK UP ^^^^^^^)!"
                  status="66"
                  if="junit.failed"/>

    </target>

</project>
